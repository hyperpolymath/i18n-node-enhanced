# Containerfile - Chainguard Wolfi-based container for i18n-node-enhanced
#
# This container provides a secure, minimal runtime environment using
# Chainguard's Wolfi distribution for supply-chain security.
#
# Build with nerdctl:
#   nerdctl build -t i18n:latest -f container/Containerfile .
#
# Build with podman:
#   podman build -t i18n:latest -f container/Containerfile .
#
# Build with docker:
#   docker build -t i18n:latest -f container/Containerfile .

# ============================================================================
# Stage 1: Builder - Full toolchain for compilation
# ============================================================================
FROM cgr.dev/chainguard/wolfi-base:latest AS builder

# Install build dependencies
RUN apk add --no-cache \
    nodejs-20 \
    npm \
    deno \
    rust \
    cargo \
    wasm-pack \
    git \
    bash \
    coreutils \
    just \
    curl \
    ca-certificates

# Set up Rust for WASM
ENV RUSTUP_HOME=/usr/local/rustup \
    CARGO_HOME=/usr/local/cargo \
    PATH=/usr/local/cargo/bin:$PATH \
    RUST_VERSION=stable

RUN rustup target add wasm32-unknown-unknown 2>/dev/null || true

# Create app directory
WORKDIR /app

# Copy package files first for better layer caching
COPY package*.json ./
COPY pnpm-lock.yaml* ./

# Install Node.js dependencies
RUN npm ci --only=production

# Copy source files
COPY . .

# Build WASM modules
WORKDIR /app/wasm
RUN if [ -f "Cargo.toml" ]; then \
        cargo build --release --target wasm32-unknown-unknown && \
        wasm-pack build --target web --out-dir ../dist/wasm; \
    fi

# Build ReScript modules
WORKDIR /app/bindings/rescript
RUN if [ -f "bsconfig.json" ]; then \
        npm install && \
        npx rescript build; \
    fi

# Build Deno modules
WORKDIR /app/deno
RUN if [ -f "deno.json" ]; then \
        deno cache mod.ts; \
    fi

WORKDIR /app

# Run tests to verify build
RUN npm test || echo "Tests completed with warnings"

# Generate SBOM
RUN npm sbom --sbom-format=cyclonedx > sbom.json 2>/dev/null || echo '{}' > sbom.json

# ============================================================================
# Stage 2: Deno Runtime - For Deno-based deployments
# ============================================================================
FROM cgr.dev/chainguard/deno:latest AS deno-runtime

WORKDIR /app

# Copy built artifacts
COPY --from=builder /app/deno ./deno
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/locales ./locales
COPY --from=builder /app/sbom.json ./

# Set Deno permissions
ENV DENO_DIR=/app/.deno

# Expose default port
EXPOSE 3000

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD deno eval "Deno.exit(0)" || exit 1

# Default command
ENTRYPOINT ["deno", "run", "--allow-read", "--allow-net", "--allow-env"]
CMD ["deno/mod.ts"]

# ============================================================================
# Stage 3: Node Runtime - For Node.js-based deployments
# ============================================================================
FROM cgr.dev/chainguard/node:latest AS node-runtime

WORKDIR /app

# Copy built artifacts from builder
COPY --from=builder /app/i18n.js ./
COPY --from=builder /app/index.js ./
COPY --from=builder /app/package.json ./
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/locales ./locales
COPY --from=builder /app/sbom.json ./

# Create non-root user directories
RUN mkdir -p /app/data && chown -R nonroot:nonroot /app

# Switch to non-root user
USER nonroot

# Environment variables
ENV NODE_ENV=production \
    I18N_DIRECTORY=/app/locales \
    I18N_DEFAULT_LOCALE=en

# Expose default port
EXPOSE 3000

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD node -e "process.exit(0)" || exit 1

# Default command
ENTRYPOINT ["node"]
CMD ["index.js"]

# ============================================================================
# Stage 4: CLI - Minimal CLI-only container
# ============================================================================
FROM cgr.dev/chainguard/node:latest AS cli

WORKDIR /app

# Copy only CLI-related files
COPY --from=builder /app/i18n.js ./
COPY --from=builder /app/index.js ./
COPY --from=builder /app/package.json ./
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/tools ./tools
COPY --from=builder /app/locales ./locales

# Create wrapper script
RUN echo '#!/bin/sh\nnode /app/tools/cli.js "$@"' > /usr/local/bin/i18n && \
    chmod +x /usr/local/bin/i18n

USER nonroot

ENTRYPOINT ["i18n"]
CMD ["--help"]

# ============================================================================
# Stage 5: Static - Distroless minimal runtime
# ============================================================================
FROM cgr.dev/chainguard/static:latest AS static

WORKDIR /app

# Copy only the absolute minimum
COPY --from=builder /app/dist/wasm ./wasm
COPY --from=builder /app/sbom.json ./

# No entrypoint - this is a library container
# Mount and use from other containers

# ============================================================================
# Stage 6: Development - Full development environment
# ============================================================================
FROM cgr.dev/chainguard/wolfi-base:latest AS dev

# Install all development tools
RUN apk add --no-cache \
    nodejs-20 \
    npm \
    deno \
    rust \
    cargo \
    wasm-pack \
    git \
    bash \
    zsh \
    fish \
    just \
    curl \
    wget \
    ripgrep \
    fd \
    bat \
    jq \
    yq \
    fzf \
    vim \
    neovim \
    helix \
    direnv \
    watchexec \
    ca-certificates \
    gnupg \
    openssh-client

# Install Nickel (configuration language)
RUN curl -sSL https://github.com/tweag/nickel/releases/latest/download/nickel-linux-x86_64 \
    -o /usr/local/bin/nickel && chmod +x /usr/local/bin/nickel || true

WORKDIR /app

# Copy all source files
COPY --from=builder /app .

# Set up shell environment
ENV SHELL=/bin/bash \
    TERM=xterm-256color

# Development entrypoint
ENTRYPOINT ["/bin/bash"]

# ============================================================================
# Default target: Node runtime
# ============================================================================
FROM node-runtime AS default

# Labels for container metadata
LABEL org.opencontainers.image.title="i18n-node-enhanced" \
      org.opencontainers.image.description="Lightweight translation module with dynamic JSON storage" \
      org.opencontainers.image.url="https://github.com/mashpie/i18n-node" \
      org.opencontainers.image.source="https://github.com/mashpie/i18n-node" \
      org.opencontainers.image.vendor="i18n-node-enhanced" \
      org.opencontainers.image.licenses="MIT" \
      org.opencontainers.image.base.name="cgr.dev/chainguard/node:latest" \
      dev.chainguard.image.type="production"
